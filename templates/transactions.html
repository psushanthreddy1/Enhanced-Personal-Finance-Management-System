<!DOCTYPE html>
<html lang="en">
<head>
  <title>Transaction Details</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background: #111;
      font-family: Arial;
      color: white;
    }

    /* ‚úÖ Sidebar */
    .sidebar {
      width: 260px;
      height: 100vh;
      background: #000;
      position: fixed;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar h3 {
      font-weight: bold;
      margin-bottom: 30px;
    }

    .sidebar p {
      font-size: 12px;
      color: gray;
      margin-top: 25px;
    }

    .sidebar a {
      display: block;
      padding: 12px;
      margin: 6px 0;
      color: white;
      text-decoration: none;
      border-radius: 10px;
      font-size: 15px;
    }

    .sidebar a:hover {
      background: orange;
      color: black;
    }

    /* ‚úÖ Main Content */
    .content {
      margin-left: 280px;
      padding: 20px;
    }

    /* ‚úÖ Layout Box */
    .main-box {
      background: #1b1b1b;
      border-radius: 12px;
      height: 92vh;
      display: flex;
    }

    .table-scroll{
    max-height: 420px;
    overflow-y: auto;
    border-radius:10px;
    }

    .table-scroll::-webkit-scrollbar{
    width:8px;
}

.table-scroll::-webkit-scrollbar-thumb{
    background:orange;
    border-radius:10px;
}

.table-scroll::-webkit-scrollbar-track{
    background:#111;
}

    /* ‚úÖ Left Filter Panel */
    .filter-panel {
      width: 280px;
      border-right: 1px solid #333;
      padding: 20px;
    }

    /* ‚úÖ Dropdown Style */
    .form-select {
      background-color: #111 !important;
      color: white !important;
      border: 1px solid #555 !important;
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      box-shadow: none !important;
    }

    .form-select:focus {
      border-color: orange !important;
      outline: none !important;
      box-shadow: none !important;
    }

    /* ‚úÖ Tabs */
    .tab-box button {
      width: 100%;
      background: transparent;
      border: none;
      padding: 12px;
      color: white;
      text-align: left;
      border-radius: 8px;
      font-size: 15px;
    }

    .tab-box button.active {
      background: #2a2a2a;
      color: orange;
    }

    /* ‚úÖ Right Table Panel */
    .table-panel {
      flex: 1;
      padding: 20px;
    }

    /* ‚úÖ Search */
    .search-box {
      width: 280px;
      background: #111;
      border: 1px solid #444;
      color: white;
      padding: 8px;
      border-radius: 8px;
    }

    /* ‚úÖ Table */
    table th {
      font-size: 13px;
      color: white;
      font-weight: bold;
      border-bottom: 1px solid #333;
    }

    table td {
      border-bottom: 1px solid #222;
    }

    /* ‚úÖ Pagination */
    .pagination-box {
      text-align: center;
      margin-top: 20px;
      color: orange;
    }

    .page-btn {
      display: inline-block;
      padding: 6px 14px;
      margin: 0 10px;
      background: #2a2a2a;
      border-radius: 6px;
    }

    /* ‚úÖ Calendar Grid */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      background: #1c1c1c;
      padding: 15px;
      border-radius: 12px;
    }

    /* Calendar Header */
    .day-header {
      font-weight: bold;
      color: white;
      text-align: center;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    /* Calendar Days */
    .day {
      height: 60px;
      border-radius: 8px;
      text-align: center;
      line-height: 60px;
      background: #222;
      color: #bbb;
      cursor: pointer;
    }

    .day:hover {
      background: orange;
      color: black;
    }

    .empty {
      background: transparent;
      cursor: default;
    }

    /* Highlight Selected */
    .active-day {
      background: #3a2a1a;
      border: 1px solid orange;
      color: orange;
    }
  </style>
</head>

<body>

<!-- ‚úÖ Sidebar -->
<div class="sidebar">
  <h3> Money Map</h3>
<!-- Overview -->
  <a href="/">üè† Overview</a>

  <!-- Transaction Section -->
  <p>TRANSACTION DATA</p>
  <a href="/transactions">üìÑ Transaction Details</a>
  <a href="/analysis">üìä Statistics & Analysis</a>
  

  <!-- Basis Data -->
  <p>BASIS DATA</p>
  <a href="/accounts">üè¶ Accounts</a>
  <a href="/categories">üìÇ Transaction Categories</a>
  <a href="/budget">üí∞ Budget Planner</a>
  <a href="/alerts">üö® Alerts</a>
</div>

<!-- ‚úÖ Main Content -->
<div class="content">

  <div class="main-box">

    <!-- ‚úÖ Left Filters -->
    <div class="filter-panel">

      <!-- Tabs -->
      <div class="tab-box mb-4">
        <button class="active" onclick="showList()" id="listBtn">
          Transaction List
        </button>

        <button onclick="showCalendar()" id="calBtn">
          Transaction Calendar
        </button>
      </div>

      <form method="get" action="/transactions">

    <label class="mb-1">Transaction Type</label>

    <select name="txn_type"
            class="form-select mb-3"
            onchange="this.form.submit()">

        <option value="">All Types</option>

        <option value="income"
            {% if txn_type == 'income' %}selected{% endif %}>
            Income
        </option>

        <option value="expense"
            {% if txn_type == 'expense' %}selected{% endif %}>
            Expense
        </option>

    </select>

</form>


      
    </div>

    <!-- ‚úÖ Right Side -->
    <div class="table-panel">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="top-actions">
          <button class="btn btn-warning btn-sm"
             data-bs-toggle="modal"
             data-bs-target="#addTxnModal">
            Add
          </button>
          <form id="importForm"
      action="/import-transactions"
      method="post"
      enctype="multipart/form-data"
      style="display:inline;">

    <!-- Hidden File Input -->
    <input type="file"
           id="importFile"
           name="file"
           accept=".xlsx"
           style="display:none"
           onchange="document.getElementById('importForm').submit();">

    <!-- Import Button -->
    <button type="button"
            class="btn btn-outline-light btn-sm"
            onclick="document.getElementById('importFile').click();">
        Import
    </button>

</form>

         <a href="/export-transactions" class="btn btn-success btn-sm">
         Export
         </a>

        
        </div>

        <form method="get" action="/transactions" class="d-flex">

    <input
        class="search-box me-2"
        name="search"
        value="{{ search if search else '' }}"
        placeholder="Search merchant, category, account...">

    <button class="btn btn-warning btn-sm">
        Search
    </button>

</form>
      </div>

      <!-- ‚úÖ Calendar View -->
      <div id="calendarView" style="display:none; margin-bottom:20px;">

        <!-- ‚úÖ Month & Year Selector Added -->
        

        <!-- ‚úÖ Dynamic Month-Year Title -->
        <h4>
          {{ month_name }} {{ year }}
        </h4>

        <div class="calendar-grid">

  <div class="day-header">Sunday</div>
  <div class="day-header">Monday</div>
  <div class="day-header">Tuesday</div>
  <div class="day-header">Wednesday</div>
  <div class="day-header">Thursday</div>
  <div class="day-header">Friday</div>
  <div class="day-header">Saturday</div>

  {% for week in calendar %}
      {% for day in week %}
          {% if day == 0 %}
              <div class="day empty"></div>
          {% else %}
              {% set current_date = "%04d-%02d-%02d"|format(year, month, day) %}

              <a href="/transactions?selected_date={{ current_date }}"
                class="day {% if selected_date == current_date %}active-day{% endif %}">
                {{ day }}
              </a>
          {% endif %}
      {% endfor %}
  {% endfor %}

</div>
      </div>

      <!-- ‚úÖ Transaction Table -->



<!-- List View -->
<div id="listView">

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-success text-white p-3">
                <h5>Total Income</h5>
                <h4>‚Çπ {{ total_income }}</h4>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-danger text-white p-3">
                <h5>Total Expense</h5>
                <h4>‚Çπ {{ total_expense }}</h4>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-dark text-white p-3">
                <h5>Net Balance</h5>
                <h4>‚Çπ {{ net_balance }}</h4>
            </div>
        </div>
    </div>

    <!-- Table -->
     <div class="table-scroll">
    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th>DATE </th>
                <th>CATEGORY </th>
                <th>AMOUNT </th>
                <th>ACCOUNT </th>
                <th>TAGS </th>
                <th>DESCRIPTION</th>
                <th>ACTIONS</th>
            </tr>
        </thead>

        <tbody>
            {% if transactions %}
                {% for txn in transactions %}
                <tr>
                    <td>{{ txn[6] }}</td>
                    <td>{{ txn[5] }}</td>
                    <td>‚Çπ {{ txn[2] }}</td>
                    <td>{{ txn[3] }}</td>
                    <td>{{ txn[4] }}</td>
                    <td>{{ txn[1] }}</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#editTxnModal"
                            onclick="openEditModal(
                                '{{ txn[0] }}',
                                '{{ txn[1] }}',
                                '{{ txn[2] }}',
                                '{{ txn[3] }}',
                                '{{ txn[4] }}',
                                '{{ txn[6] }}'
                            )">
                            Edit
                        </button>

                        <a href="/delete-transaction/{{ txn[0] }}"
                           class="btn btn-sm btn-danger">
                           Delete
                        </a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        No transactions available for this date.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>

</div>

      

    </div>
  </div>
</div>

<!-- ‚úÖ Scripts -->
<script>
  function showCalendar() {
    document.getElementById("calendarView").style.display = "block";
    document.getElementById("listView").style.display = "none";

    document.getElementById("calBtn").classList.add("active");
    document.getElementById("listBtn").classList.remove("active");
  }

  function showList() {
    document.getElementById("calendarView").style.display = "none";
    document.getElementById("listView").style.display = "block";

    document.getElementById("listBtn").classList.add("active");
    document.getElementById("calBtn").classList.remove("active");
  }
</script>
<!-- Add Transaction Modal -->
<div class="modal fade" id="addTxnModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white p-4">

      <h4>Add New Transaction</h4>
      <hr>

      <form action="/save-transaction" method="post">

        <label>Merchant</label>
        <input type="text" name="merchant"
               class="form-control mb-3" required>

        <label>Amount</label>
        <input type="number" name="amount"
               class="form-control mb-3" required>

        <label>Select Account</label>
        <select name="account_id" class="form-control mb-3">
          {% for acc in accounts %}
            <option value="{{ acc[0] }}">{{ acc[3] }}</option>
          {% endfor %}
        </select>

        <label>Transaction Type</label>
<select name="txn_type"
        id="edit_txn_type"
        class="form-control mb-3">
    <option value="expense">Expense</option>
    <option value="income">Income</option>
</select>

        <label>Date</label>
        <input type="date" name="txn_date"
               class="form-control mb-3" required>

        <div class="text-center">
          <button class="btn btn-warning px-4">Save</button>
          <button type="button"
                  class="btn btn-secondary px-4 ms-3"
                  data-bs-dismiss="modal">
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>
</div>
<script>
function openEditModal(id, merchant, amount, account_id, txn_type, txn_date) {

    document.getElementById("edit_txn_id").value = id;
    document.getElementById("edit_merchant").value = merchant;
    document.getElementById("edit_amount").value = amount;
    document.getElementById("edit_account").value = account_id;
    document.getElementById("edit_txn_date").value = txn_date;

    // VERY IMPORTANT
    document.getElementById("editForm").action =
        "/update-transaction/" + id;
}
</script>
<!-- Edit Transaction Modal -->
<div class="modal fade" id="editTxnModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white p-4">

      <h4>Edit Transaction</h4>
      <hr>

      <form id="editForm" method="post">

        <input type="hidden" name="txn_id" id="edit_txn_id">

        <label>Merchant</label>
        <input type="text" name="merchant"
               id="edit_merchant"
               class="form-control mb-3" required>

        <label>Amount</label>
        <input type="number" name="amount"
               id="edit_amount"
               class="form-control mb-3" required>

        <label>Select Account</label>
<select name="account_id"
        id="edit_account"
        class="form-control mb-3">
  {% for acc in accounts %}
    <option value="{{ acc[0] }}">{{ acc[3] }}</option>
  {% endfor %}
</select>

<!-- ADD THIS -->
<label>Transaction Type</label>
<select name="txn_type"
        id="edit_txn_type"
        class="form-control mb-3">
    <option value="expense">Expense</option>
    <option value="income">Income</option>
</select>

<label>Date</label>
<input type="date"
       name="txn_date"
       id="edit_txn_date"
       class="form-control mb-3"
       required>

        <div class="text-center">
          <button class="btn btn-warning px-4">Update</button>
          <button type="button"
                  class="btn btn-secondary px-4 ms-3"
                  data-bs-dismiss="modal">
            Cancel
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if alert_message %}

<div class="modal fade" id="budgetAlertModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header border-0">
        <h5 class="modal-title text-danger">
          ‚ö† Budget Exceeded!
        </h5>
      </div>

      <div class="modal-body text-center">
        <p>{{ alert_message.replace("Budget:", "Budget: ‚Çπ").replace("Spent:", "Spent: ‚Çπ") }}</p>
      </div>

      <div class="modal-footer border-0 justify-content-center">
        <button type="button"
                class="btn btn-warning"
                data-bs-dismiss="modal">
          OK
        </button>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    var alertModal = new bootstrap.Modal(
        document.getElementById('budgetAlertModal')
    );
    alertModal.show();

    // clear cookie after showing
    document.cookie = "budget_alert=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
});
</script>

{% endif %}
</body>
</html>